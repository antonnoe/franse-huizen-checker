<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Franse Huizen Tool - Prijzen Checker & Valkuilen Checklist</title>
    <meta name="description" content="Controleer huizenprijzen in Frankrijk en vermijd valkuilen bij de aankoop. Gebaseerd op 30+ jaar ervaring en officiÃ«le DVF data.">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (let op: React 17 i.p.v. 18!) -->
    <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { margin:0; font-family:sans-serif; background:#f4f4f4; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
    // Beschikbaar maken van Lucide iconen
    const {
        Search, Home, CheckCircle2, Circle, MapPin, TrendingUp,
        AlertTriangle, ChevronDown, ChevronUp, ExternalLink
    } = lucide;

    // ---- BanAddressSearch component ----
    function BanAddressSearch({ onAddressSelect }) {
        const [query, setQuery] = React.useState('');
        const [suggestions, setSuggestions] = React.useState([]);
        const [loading, setLoading] = React.useState(false);

        React.useEffect(() => {
            const searchAddress = async () => {
                if (query.length < 3) {
                    setSuggestions([]);
                    return;
                }
                setLoading(true);
                try {
                    const response = await fetch(
                        `https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=5`
                    );
                    const data = await response.json();
                    setSuggestions(data.features || []);
                } catch (error) {
                    setSuggestions([]);
                } finally {
                    setLoading(false);
                }
            };
            const debounce = setTimeout(searchAddress, 300);
            return () => clearTimeout(debounce);
        }, [query]);

        const handleSelect = (feature) => {
            const address = {
                label: feature.properties.label,
                coordinates: feature.geometry.coordinates,
                city: feature.properties.city,
                postcode: feature.properties.postcode,
                context: feature.properties.context
            };
            onAddressSelect(address);
            setQuery(feature.properties.label);
            setSuggestions([]);
        };
        return (
            <div className="relative">
                <div className="relative">
                    <MapPin className="absolute left-3 top-3 text-gray-400" size={20} />
                    <input
                        type="text"
                        value={query}
                        onChange={e => setQuery(e.target.value)}
                        placeholder="Typ een adres in Frankrijk..."
                        className="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-lg focus:border-[#800000] focus:outline-none"
                    />
                </div>
                {suggestions.length > 0 &&
                    <div className="absolute z-10 w-full mt-1 bg-white border-2 border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                        {suggestions.map((feature, idx) => (
                            <button
                                key={idx}
                                onClick={() => handleSelect(feature)}
                                className="w-full px-4 py-3 text-left hover:bg-gray-50 border-b border-gray-100 last:border-b-0"
                            >
                                <div className="font-medium text-gray-900">{feature.properties.name}</div>
                                <div className="text-sm text-gray-600">{feature.properties.context}</div>
                            </button>
                        ))}
                    </div>
                }
                {loading &&
                    <div className="absolute right-3 top-3 text-gray-400">
                        Zoeken...
                    </div>
                }
            </div>
        );
    }

    // ---- PriceChecker component ----
    function PriceChecker({ address }) {
        const [priceData, setPriceData] = React.useState(null);
        const [loading, setLoading] = React.useState(false);
        const [error, setError] = React.useState(null);

        React.useEffect(() => {
            async function fetchPrices() {
                if (!address || !address.coordinates) return;
                setLoading(true);
                setError(null);
                try {
                    const [lng, lat] = address.coordinates;
                    const radius = 5000;
                    const latOffset = radius / 111000;
                    const lngOffset = radius / (111000 * Math.cos(lat * Math.PI / 180));
                    
                    const response = await fetch(
                        `https://apidf-preprod.cerema.fr/dvf_opendata/geomutations?` +
                        `in_bbox=${lng - lngOffset},${lat - latOffset},${lng + lngOffset},${lat + latOffset}&` +
                        `limit=50`
                    );

                    if (!response.ok) throw new Error('API niet beschikbaar');
                    const data = await response.json();

                    if (data.features && data.features.length > 0) {
                        const sales = data.features.map(f => ({
                            price: f.properties.valeur_fonciere,
                            date: f.properties.date_mutation,
                            type: f.properties.type_local,
                            surface: f.properties.surface_reelle_bati,
                            address: f.properties.adresse_nom_voie,
                            city: f.properties.nom_commune
                        })).filter(s => s.price && s.price > 0);

                        const avgPrice = sales.reduce((sum, s) => sum + s.price, 0) / sales.length;
                        const avgPricePerM2 = sales
                            .filter(s => s.surface && s.surface > 0)
                            .reduce((sum, s) => sum + (s.price / s.surface), 0) /
                            sales.filter(s => s.surface && s.surface > 0).length;

                        setPriceData({
                            sales: sales.slice(0, 10),
                            avgPrice: Math.round(avgPrice),
                            avgPricePerM2: Math.round(avgPricePerM2),
                            totalSales: sales.length,
                            minPrice: Math.min(...sales.map(s => s.price)),
                            maxPrice: Math.max(...sales.map(s => s.price))
                        });
                    } else {
                        setError('Geen recente verkopen gevonden in dit gebied');
                    }
                } catch (err) {
                    setError('Kon prijsdata niet ophalen. Probeer het later opnieuw.');
                } finally {
                    setLoading(false);
                }
            }
            if (address) fetchPrices();
        }, [address]);

        if (!address) {
            return (
                <div className="text-center py-12 text-gray-500">
                    <Home size={48} className="mx-auto mb-4 opacity-50" />
                    <p>Voer een adres in om prijzen te bekijken</p>
                </div>
            );
        }
        if (loading) {
            return (
                <div className="text-center py-12">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#800000] mx-auto"></div>
                    <p className="mt-4 text-gray-600">Prijsdata ophalen...</p>
                </div>
            );
        }
        if (error) {
            return (
                <div className="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-6 text-center">
                    <AlertTriangle className="mx-auto mb-2 text-yellow-600" size={32} />
                    <p className="text-yellow-800">{error}</p>
                </div>
            );
        }
        if (!priceData) return null;

        return (
            <div className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div className="bg-gradient-to-br from-[#800000] to-[#a00000] text-white rounded-lg p-6">
                        <div className="text-sm opacity-90 mb-1">Gemiddelde prijs</div>
                        <div className="text-3xl font-bold">â‚¬{priceData.avgPrice.toLocaleString()}</div>
                        <div className="text-xs opacity-75 mt-2">{priceData.totalSales} verkopen</div>
                    </div>
                    <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-6">
                        <div className="text-sm text-blue-800 mb-1">Prijs per mÂ²</div>
                        <div className="text-3xl font-bold text-blue-900">â‚¬{priceData.avgPricePerM2.toLocaleString()}</div>
                        <div className="text-xs text-blue-700 mt-2">Gemiddeld</div>
                    </div>
                    <div className="bg-green-50 border-2 border-green-200 rounded-lg p-6">
                        <div className="text-sm text-green-800 mb-1">Prijsrange</div>
                        <div className="text-lg font-bold text-green-900">
                            â‚¬{(priceData.minPrice / 1000).toFixed(0)}k - â‚¬{(priceData.maxPrice / 1000).toFixed(0)}k
                        </div>
                        <div className="text-xs text-green-700 mt-2">Min - Max</div>
                    </div>
                </div>

                <div className="bg-white border-2 border-gray-200 rounded-lg p-6">
                    <h3 className="font-bold text-lg mb-4 flex items-center gap-2">
                        <TrendingUp size={20} className="text-[#800000]" />
                        Recente verkopen binnen 5km
                    </h3>
                    <div className="space-y-3 max-h-96 overflow-y-auto">
                        {priceData.sales.map((sale, idx) => (
                            <div key={idx} className="border-l-4 border-[#800000] bg-gray-50 p-4 rounded">
                                <div className="flex justify-between items-start">
                                    <div className="flex-1">
                                        <div className="font-medium text-gray-900">
                                            {sale.address || 'Adres onbekend'}, {sale.city}
                                        </div>
                                        <div className="text-sm text-gray-600 mt-1">
                                            {sale.type} â€¢ {sale.surface ? `${sale.surface}mÂ²` : 'Oppervlakte onbekend'}
                                        </div>
                                        <div className="text-xs text-gray-500 mt-1">
                                            {new Date(sale.date).toLocaleDateString('nl-NL')}
                                        </div>
                                    </div>
                                    <div className="text-right ml-4">
                                        <div className="font-bold text-lg text-[#800000]">
                                            â‚¬{sale.price.toLocaleString()}
                                        </div>
                                        {sale.surface > 0 &&
                                            <div className="text-sm text-gray-600">â‚¬{Math.round(sale.price / sale.surface)}/mÂ²</div>
                                        }
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
                <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 text-sm text-blue-800">
                    <strong>Let op:</strong> Data afkomstig van DVF (Demandes de Valeurs FonciÃ¨res), 
                    officiÃ«le Franse overheidsdata. Updates 2x per jaar. Prijzen zijn exclusief notariskosten en makelaarscourtage.
                </div>
            </div>
        );
    }

    // ---- Checklist component (sterk ingekort, voeg je eigen valkuilen array in!) ----
    function Checklist() {
        const VALKUILEN = [
            { id: 1, title: "De impulsieve aankoop", description: "Koop niet impulsief zonder doordachte checklist.", category: "voorbereiding" },
            { id: 2, title: "Makelaar kosten", description: "Overweeg P Ã  P aankoop om makelaarskosten te besparen.", category: "financieel" },
            { id: 3, title: "Lokkertjes op websites", description: "Verifieer altijd of het huis nog beschikbaar is.", category: "zoektocht" }
            // ... eventueel uitbreiden met alle valkuilen ...
        ];

        const categories = {
            all: 'Alle',
            voorbereiding: 'Voorbereiding',
            financieel: 'Financieel'
            // ... aanvullende categorieÃ«n ...
        };

        const [checkedItems, setCheckedItems] = React.useState({});
        const [selectedCategory, setSelectedCategory] = React.useState('all');
        const [expandedItems, setExpandedItems] = React.useState({});

        React.useEffect(() => {
            const saved = localStorage.getItem('checklist');
            if (saved) setCheckedItems(JSON.parse(saved));
        }, []);

        const filteredValkuilen = selectedCategory === 'all'
            ? VALKUILEN
            : VALKUILEN.filter(v => v.category === selectedCategory);

        const toggleCheck = id => {
            setCheckedItems(prev => {
                const updated = { ...prev, [id]: !prev[id] };
                localStorage.setItem('checklist', JSON.stringify(updated));
                return updated;
            });
        };
        const toggleExpand = id => setExpandedItems(prev => ({ ...prev, [id]: !prev[id] }));

        const progress = (Object.values(checkedItems).filter(Boolean).length / VALKUILEN.length) * 100;
        return (
            <div className="space-y-6">
                <div className="bg-gradient-to-r from-[#800000] to-[#a00000] text-white rounded-lg p-6">
                    <h3 className="text-2xl font-bold mb-2">Uw voortgang</h3>
                    <div className="flex items-center gap-4">
                        <div className="flex-1 bg-white/20 rounded-full h-4 overflow-hidden">
                            <div className="bg-white h-full transition-all duration-300" style={{ width: `${progress}%` }}/>
                        </div>
                        <div className="text-2xl font-bold">{Math.round(progress)}%</div>
                    </div>
                    <div className="text-sm opacity-90 mt-2">{Object.values(checkedItems).filter(Boolean).length} van {VALKUILEN.length} punten afgevinkt</div>
                </div>
                <div className="flex flex-wrap gap-2">
                    {Object.entries(categories).map(([key, label]) => (
                        <button
                            key={key}
                            onClick={() => setSelectedCategory(key)}
                            className={`px-4 py-2 rounded-full text-sm font-medium transition-colors ${
                                selectedCategory === key
                                    ? 'bg-[#800000] text-white'
                                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                            }`}
                        >
                            {label}
                        </button>
                    ))}
                </div>
                <div className="space-y-3">
                    {filteredValkuilen.map(item => (
                        <div key={item.id} className={`border-2 rounded-lg transition-all ${
                            checkedItems[item.id] ? 'border-green-300 bg-green-50' : 'border-gray-200 bg-white'
                        }`}>
                            <div className="p-4">
                                <div className="flex items-start gap-3">
                                    <button onClick={() => toggleCheck(item.id)} className="mt-1 flex-shrink-0">
                                        {checkedItems[item.id]
                                            ? <CheckCircle2 className="text-green-600" size={24} />
                                            : <Circle className="text-gray-400" size={24} />
                                        }
                                    </button>
                                    <div className="flex-1">
                                        <button onClick={() => toggleExpand(item.id)} className="w-full text-left">
                                            <div className="flex items-start justify-between gap-2">
                                                <h4 className={`font-bold ${checkedItems[item.id] ? 'line-through text-gray-600' : 'text-gray-900'}`}>
                                                    {item.id}. {item.title}
                                                </h4>
                                                {expandedItems[item.id]
                                                    ? <ChevronUp className="text-gray-400 flex-shrink-0" size={20} />
                                                    : <ChevronDown className="text-gray-400 flex-shrink-0" size={20} />
                                                }
                                            </div>
                                        </button>
                                        {expandedItems[item.id] && (
                                            <div className="mt-2 text-gray-700 text-sm leading-relaxed">
                                                {item.description}
                                            </div>
                                        )}
                                        <div className="mt-2">
                                            <span className="inline-block px-2 py-1 bg-[#800000]/10 text-[#800000] text-xs rounded-full">
                                                {categories[item.category] || item.category}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
                <div className="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 text-sm">
                    <strong>ðŸ’¡ Tip:</strong> Deze checklist wordt automatisch opgeslagen in uw browser. U kunt later terugkomen om verder te gaan waar u gebleven was.
                </div>
            </div>
        );
    }

    // ---- Main App component ----
    function FranseHuizenTool() {
        const [activeTab, setActiveTab] = React.useState('prijzen');
        const [selectedAddress, setSelectedAddress] = React.useState(null);

        const tabs = [
            { id: 'prijzen', label: 'Prijzen Checker', icon: TrendingUp },
            { id: 'checklist', label: 'Valkuilen Checklist', icon: CheckCircle2 }
        ];

        return (
            <div className="min-h-screen bg-gray-50">
                <div className="max-w-6xl mx-auto p-4 md:p-8">
                    <div className="bg-gradient-to-r from-[#800000] to-[#a00000] text-white rounded-lg p-8 mb-8 shadow-xl">
                        <div className="flex items-center gap-3 mb-4">
                            <Home size={40} />
                            <h1 className="text-3xl md:text-4xl font-bold">Franse Huizen Tool</h1>
                        </div>
                        <p className="text-lg opacity-90">
                            Controleer prijzen, vermijd valkuilen en maak een geÃ¯nformeerde keuze bij het kopen van uw huis in Frankrijk
                        </p>
                        <div className="mt-4 flex items-center gap-2 text-sm opacity-75">
                            <ExternalLink size={16} />
                            <span>Powered by officiÃ«le Franse overheidsdata (DVF + BAN)</span>
                        </div>
                    </div>
                    <div className="flex gap-2 mb-6 border-b-2 border-gray-200">
                        {tabs.map(tab => {
                            const Icon = tab.icon;
                            return (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`flex items-center gap-2 px-6 py-3 font-medium transition-colors relative ${
                                        activeTab === tab.id ? 'text-[#800000]' : 'text-gray-600 hover:text-gray-900'
                                    }`}
                                >
                                    <Icon size={20} />
                                    {tab.label}
                                    {activeTab === tab.id && (
                                        <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-[#800000]" />
                                    )}
                                </button>
                            );
                        })}
                    </div>
                    <div className="bg-white rounded-lg shadow-lg p-6 md:p-8">
                        {activeTab === 'prijzen' && (
                            <div className="space-y-6">
                                <div>
                                    <h2 className="text-2xl font-bold text-gray-900 mb-4">
                                        Zoek een adres in Frankrijk
                                    </h2>
                                    <BanAddressSearch onAddressSelect={setSelectedAddress} />
                                </div>
                                {selectedAddress && (
                                    <div className="bg-gray-50 border-2 border-gray-200 rounded-lg p-4">
                                        <div className="font-medium text-gray-900">{selectedAddress.label}</div>
                                        <div className="text-sm text-gray-600">{selectedAddress.context}</div>
                                    </div>
                                )}
                                <PriceChecker address={selectedAddress} />
                            </div>
                        )}
                        {activeTab === 'checklist' && (
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900 mb-2">
                                    Valkuilen bij het kopen van een huis in Frankrijk
                                </h2>
                                <p className="text-gray-600 mb-6">
                                    Gebaseerd op 30+ jaar ervaring. Vink af wat u al heeft gecontroleerd of overwogen.
                                </p>
                                <Checklist />
                            </div>
                        )}
                    </div>
                    <div className="mt-8 text-center text-sm text-gray-600">
                        <p>
                            Meer informatie op{' '}
                            <a href="https://infofrankrijk.com" target="_blank" rel="noopener noreferrer" className="text-[#800000] hover:underline font-medium">
                                InfoFrankrijk.com
                            </a> â€¢{' '}
                            <a href="https://nederlanders.fr" target="_blank" rel="noopener noreferrer" className="text-[#800000] hover:underline font-medium">
                                Nederlanders.fr
                            </a>
                        </p>
                        <p className="mt-2 opacity-75">
                            Communities Abroad Â© 2025
                        </p>
                    </div>
                </div>
            </div>
        );
    }

    // Start de app
    ReactDOM.render(<FranseHuizenTool />, document.getElementById('root'));
    </script>
</body>
</html>
